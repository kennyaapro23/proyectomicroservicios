<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/com/example/msauth/entity/TokenDto.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/example/msauth/entity/TokenDto.java" />
              <option name="originalContent" value="package com.example.msauth.entity;&#10;&#10;import com.fasterxml.jackson.annotation.JsonProperty;&#10;import lombok.AllArgsConstructor;&#10;import lombok.Data;&#10;import lombok.NoArgsConstructor;&#10;&#10;@Data&#10;@AllArgsConstructor&#10;@NoArgsConstructor&#10;public class TokenDto {&#10;&#10;    @JsonProperty(&quot;token&quot;)&#10;    private String token;&#10;&#10;    @JsonProperty(&quot;userName&quot;)&#10;    private String userName;&#10;&#10;    @JsonProperty(&quot;role&quot;)&#10;    private String role;&#10;&#10;    @JsonProperty(&quot;clientId&quot;)&#10;    private Integer clientId;&#10;&#10;    @JsonProperty(&quot;id&quot;)&#10;    private Long id;&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.msauth.entity;&#10;&#10;import com.fasterxml.jackson.annotation.JsonProperty;&#10;import lombok.AllArgsConstructor;&#10;import lombok.Data;&#10;import lombok.NoArgsConstructor;&#10;&#10;@Data&#10;@AllArgsConstructor&#10;@NoArgsConstructor&#10;public class TokenDto {&#10;&#10;    @JsonProperty(&quot;token&quot;)&#10;    private String token;&#10;&#10;    @JsonProperty(&quot;userName&quot;)&#10;    private String userName;&#10;&#10;    @JsonProperty(&quot;role&quot;)&#10;    private String role;&#10;&#10;    @JsonProperty(&quot;clientId&quot;)&#10;    private Integer clientId;&#10;&#10;    @JsonProperty(&quot;id&quot;)&#10;    private Integer id; // Cambiado de Long a Integer para coincidir con AuthUser.id&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/com/example/msauth/service/impl/AuthUserServiceImpl.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/example/msauth/service/impl/AuthUserServiceImpl.java" />
              <option name="originalContent" value="package com.example.msauth.service.impl;&#10;&#10;import com.example.msauth.dto.AuthUserDto;&#10;import com.example.msauth.dto.ClientDto;&#10;import com.example.msauth.entity.AuthUser;&#10;import com.example.msauth.entity.TokenDto;&#10;import com.example.msauth.enums.Roles;&#10;import com.example.msauth.feign.ClientFeign;&#10;import com.example.msauth.repository.AuthUserRepository;&#10;import com.example.msauth.security.JwtProvider;&#10;import com.example.msauth.service.AuthUserService;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.stereotype.Service;&#10;&#10;import java.util.List;&#10;import java.util.Optional;&#10;&#10;@Service&#10;public class AuthUserServiceImpl implements AuthUserService {&#10;&#10;    @Autowired&#10;    private AuthUserRepository authUserRepository;&#10;&#10;    @Autowired&#10;    private PasswordEncoder passwordEncoder;&#10;&#10;    @Autowired&#10;    private JwtProvider jwtProvider;&#10;&#10;    @Autowired&#10;    private ClientFeign clientFeign;&#10;&#10;    @Override&#10;    public List&lt;AuthUser&gt; findAll() {&#10;        return authUserRepository.findAll();&#10;    }&#10;&#10;    @Override&#10;    public AuthUser save(AuthUserDto authUserDto) {&#10;        Optional&lt;AuthUser&gt; user = authUserRepository.findByUserName(authUserDto.getUserName());&#10;        if (user.isPresent()) {&#10;            System.out.println(&quot;⚠️ Usuario ya existe: &quot; + authUserDto.getUserName());&#10;            return null;&#10;        }&#10;&#10;        // Convertir rol seguro&#10;        Roles role;&#10;        try {&#10;            role = Roles.valueOf(authUserDto.getRole().toUpperCase());&#10;        } catch (IllegalArgumentException e) {&#10;            System.out.println(&quot;❌ Rol inválido: &quot; + authUserDto.getRole());&#10;            return null;&#10;        }&#10;&#10;        // Crear y guardar usuario sin clientId&#10;        String password = passwordEncoder.encode(authUserDto.getPassword());&#10;        AuthUser authUser = AuthUser.builder()&#10;                .userName(authUserDto.getUserName())&#10;                .password(password)&#10;                .role(role)&#10;                .build();&#10;&#10;        AuthUser savedUser = authUserRepository.save(authUser);&#10;&#10;        // Crear cliente en microservicio externo&#10;        ClientDto client = new ClientDto();&#10;        client.setName(authUserDto.getName());&#10;        client.setDocument(authUserDto.getDocument());&#10;        client.setEmail(authUserDto.getUserName()); // userName como email&#10;        client.setTelefono(authUserDto.getTelefono());&#10;&#10;        try {&#10;            ClientDto clientResponse = clientFeign.createClient(client);&#10;            System.out.println(&quot;✅ Cliente creado correctamente: &quot; + clientResponse);&#10;&#10;            // Asignar clientId al usuario y guardar de nuevo&#10;            savedUser.setClientId(clientResponse.getId());&#10;            savedUser = authUserRepository.save(savedUser);&#10;&#10;        } catch (Exception e) {&#10;            System.out.println(&quot;❌ Error al crear cliente vía Feign: &quot; + e.getMessage());&#10;            // Opcional: lanzar excepción o rollback&#10;        }&#10;&#10;        return savedUser;&#10;    }&#10;&#10;    @Override&#10;    public TokenDto login(AuthUserDto authUserDto) {&#10;        Optional&lt;AuthUser&gt; userOpt = authUserRepository.findByUserName(authUserDto.getUserName());&#10;&#10;        if (userOpt.isEmpty()) {&#10;            System.out.println(&quot;❌ Usuario no encontrado: &quot; + authUserDto.getUserName());&#10;            return null;&#10;        }&#10;&#10;        AuthUser user = userOpt.get();&#10;&#10;        if (passwordEncoder.matches(authUserDto.getPassword(), user.getPassword())) {&#10;            return new TokenDto(&#10;                    jwtProvider.createToken(user),&#10;                    user.getUserName(),&#10;                    user.getRole().name(),&#10;                    user.getClientId()&#10;            );&#10;        }&#10;&#10;        System.out.println(&quot;❌ Contraseña incorrecta&quot;);&#10;        return null;&#10;    }&#10;&#10;    @Override&#10;    public TokenDto validate(String token) {&#10;        if (!jwtProvider.validate(token)) {&#10;            System.out.println(&quot;❌ Token inválido&quot;);&#10;            return null;&#10;        }&#10;&#10;        String username = jwtProvider.getUserNameFromToken(token);&#10;        Optional&lt;AuthUser&gt; userOpt = authUserRepository.findByUserName(username);&#10;&#10;        if (userOpt.isEmpty()) {&#10;            System.out.println(&quot;❌ Usuario no encontrado con token&quot;);&#10;            return null;&#10;        }&#10;&#10;        AuthUser user = userOpt.get();&#10;&#10;        // ✅ Ahora se devuelven los datos que necesita el Gateway&#10;        return new TokenDto(&#10;                token,&#10;                user.getUserName(),&#10;                user.getRole().name(),&#10;                user.getClientId()&#10;        );&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.msauth.service.impl;&#10;&#10;import com.example.msauth.dto.AuthUserDto;&#10;import com.example.msauth.dto.ClientDto;&#10;import com.example.msauth.entity.AuthUser;&#10;import com.example.msauth.entity.TokenDto;&#10;import com.example.msauth.enums.Roles;&#10;import com.example.msauth.feign.ClientFeign;&#10;import com.example.msauth.repository.AuthUserRepository;&#10;import com.example.msauth.security.JwtProvider;&#10;import com.example.msauth.service.AuthUserService;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.stereotype.Service;&#10;&#10;import java.util.List;&#10;import java.util.Optional;&#10;&#10;@Service&#10;public class AuthUserServiceImpl implements AuthUserService {&#10;&#10;    @Autowired&#10;    private AuthUserRepository authUserRepository;&#10;&#10;    @Autowired&#10;    private PasswordEncoder passwordEncoder;&#10;&#10;    @Autowired&#10;    private JwtProvider jwtProvider;&#10;&#10;    @Autowired&#10;    private ClientFeign clientFeign;&#10;&#10;    @Override&#10;    public List&lt;AuthUser&gt; findAll() {&#10;        return authUserRepository.findAll();&#10;    }&#10;&#10;    @Override&#10;    public AuthUser save(AuthUserDto authUserDto) {&#10;        Optional&lt;AuthUser&gt; user = authUserRepository.findByUserName(authUserDto.getUserName());&#10;        if (user.isPresent()) {&#10;            System.out.println(&quot;⚠️ Usuario ya existe: &quot; + authUserDto.getUserName());&#10;            return null;&#10;        }&#10;&#10;        // Convertir rol seguro&#10;        Roles role;&#10;        try {&#10;            role = Roles.valueOf(authUserDto.getRole().toUpperCase());&#10;        } catch (IllegalArgumentException e) {&#10;            System.out.println(&quot;❌ Rol inválido: &quot; + authUserDto.getRole());&#10;            return null;&#10;        }&#10;&#10;        // Crear y guardar usuario sin clientId&#10;        String password = passwordEncoder.encode(authUserDto.getPassword());&#10;        AuthUser authUser = AuthUser.builder()&#10;                .userName(authUserDto.getUserName())&#10;                .password(password)&#10;                .role(role)&#10;                .build();&#10;&#10;        AuthUser savedUser = authUserRepository.save(authUser);&#10;&#10;        // Crear cliente en microservicio externo&#10;        ClientDto client = new ClientDto();&#10;        client.setName(authUserDto.getName());&#10;        client.setDocument(authUserDto.getDocument());&#10;        client.setEmail(authUserDto.getUserName()); // userName como email&#10;        client.setTelefono(authUserDto.getTelefono());&#10;&#10;        try {&#10;            ClientDto clientResponse = clientFeign.createClient(client);&#10;            System.out.println(&quot;✅ Cliente creado correctamente: &quot; + clientResponse);&#10;&#10;            // Asignar clientId al usuario y guardar de nuevo&#10;            savedUser.setClientId(clientResponse.getId());&#10;            savedUser = authUserRepository.save(savedUser);&#10;&#10;        } catch (Exception e) {&#10;            System.out.println(&quot;❌ Error al crear cliente vía Feign: &quot; + e.getMessage());&#10;            // Opcional: lanzar excepción o rollback&#10;        }&#10;&#10;        return savedUser;&#10;    }&#10;&#10;    @Override&#10;    public TokenDto login(AuthUserDto authUserDto) {&#10;        Optional&lt;AuthUser&gt; userOpt = authUserRepository.findByUserName(authUserDto.getUserName());&#10;&#10;        if (userOpt.isEmpty()) {&#10;            System.out.println(&quot;❌ Usuario no encontrado: &quot; + authUserDto.getUserName());&#10;            return null;&#10;        }&#10;&#10;        AuthUser user = userOpt.get();&#10;&#10;        if (passwordEncoder.matches(authUserDto.getPassword(), user.getPassword())) {&#10;            return new TokenDto(&#10;                    jwtProvider.createToken(user),&#10;                    user.getUserName(),&#10;                    user.getRole().name(),&#10;                    user.getClientId(),&#10;                    user.getId() // &lt;-- se añade el id del usuario aquí&#10;            );&#10;        }&#10;&#10;        System.out.println(&quot;❌ Contraseña incorrecta&quot;);&#10;        return null;&#10;    }&#10;&#10;    @Override&#10;    public TokenDto validate(String token) {&#10;        if (!jwtProvider.validate(token)) {&#10;            System.out.println(&quot;❌ Token inválido&quot;);&#10;            return null;&#10;        }&#10;&#10;        String username = jwtProvider.getUserNameFromToken(token);&#10;        Optional&lt;AuthUser&gt; userOpt = authUserRepository.findByUserName(username);&#10;&#10;        if (userOpt.isEmpty()) {&#10;            System.out.println(&quot;❌ Usuario no encontrado con token&quot;);&#10;            return null;&#10;        }&#10;&#10;        AuthUser user = userOpt.get();&#10;&#10;        // ✅ Ahora se devuelven los datos que necesita el Gateway&#10;        return new TokenDto(&#10;                token,&#10;                user.getUserName(),&#10;                user.getRole().name(),&#10;                user.getClientId(),&#10;                user.getId() // &lt;-- se añade el id del usuario aquí&#10;        );&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>